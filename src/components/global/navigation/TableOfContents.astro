---
export interface Props {
  contentId?: string;
}
const { contentId = "docs-content" } = Astro.props;
---

<aside
  class="hidden xl:block shrink-0 lg:w-62 overflow-y-auto scrollbar-hide px-4 pt-8 sticky top-0 self-start max-h-screen"
>
  <div class="space-y-3">
    <p class="font-medium text-sm text-foreground">On this page</p>
    <nav class="text-sm relative" id="docs-toc" data-content-id={contentId}>
      <!-- TOC will be populated by JavaScript -->
    </nav>
  </div>
</aside>

<script>
  function generateTOC() {
    const toc = document.getElementById("docs-toc");
    if (!toc) return;

    const contentId = toc.getAttribute("data-content-id") || "docs-content";
    const content = document.getElementById(contentId);
    if (!content) return;

    const headings = content.querySelectorAll("h2, h3");
    if (headings.length === 0) {
      toc.innerHTML =
        '<p class="text-muted-foreground text-sm">No sections</p>';
      return;
    }

    // Create the list with left border
    const tocList = document.createElement("ul");
    tocList.className = "border-l border-border space-y-0.1";

    headings.forEach((heading, index) => {
      // Add ID if not present
      if (!heading.id) {
        heading.id =
          heading.textContent
            ?.toLowerCase()
            .replace(/\s+/g, "-")
            .replace(/[^\w-]/g, "") || `section-${index}`;
      }

      const li = document.createElement("li");
      li.className = "relative";

      const isH3 = heading.tagName === "H3";
      li.innerHTML = `
        <a
          href="#${heading.id}"
          class="block py-1 pl-4 ${isH3 ? "pl-6" : ""} text-xs text-muted-foreground hover:text-foreground transition-colors relative"
        >
          <span class="absolute left-0 top-0 bottom-0 w-0.5 bg-primary hidden" aria-hidden="true"></span>
          ${heading.textContent}
        </a>
      `;
      tocList.appendChild(li);
    });

    toc.appendChild(tocList);

    // Scroll spy with indicator
    const tocLinks = tocList.querySelectorAll("a");
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const id = entry.target.id;
            tocLinks.forEach((link) => {
              const indicator = link.querySelector("span");
              if (link.getAttribute("href") === `#${id}`) {
                link.classList.add("text-primary", "font-medium");
                link.classList.remove("text-muted-foreground");
                indicator?.classList.remove("hidden");
              } else {
                link.classList.remove("text-primary", "font-medium");
                link.classList.add("text-muted-foreground");
                indicator?.classList.add("hidden");
              }
            });
          }
        });
      },
      { rootMargin: "-80px 0px -80% 0px" },
    );

    headings.forEach((heading) => observer.observe(heading));
  }

  generateTOC();
</script>
