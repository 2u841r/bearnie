---
import { cn } from '@/utils/cn';
import type { HTMLAttributes } from 'astro/types';

export interface Props extends HTMLAttributes<'div'> {}

const { class: className, ...props } = Astro.props;
---

<div data-command-dialog class={className} {...props}>
  <slot />
</div>

<script>
  function initCommandDialogs() {
    document.querySelectorAll('[data-command-dialog]').forEach((dialog) => {
      if (dialog.hasAttribute('data-dialog-initialized')) return;
      dialog.setAttribute('data-dialog-initialized', 'true');

      const trigger = dialog.querySelector('[data-command-dialog-trigger]');
      const overlay = dialog.querySelector('[data-command-dialog-overlay]') as HTMLElement;
      const content = dialog.querySelector('[data-command-dialog-content]') as HTMLElement;

      const openDialog = () => {
        if (overlay) overlay.hidden = false;
        if (content) {
          content.hidden = false;
          const input = content.querySelector('[data-command-input]') as HTMLInputElement;
          input?.focus();
        }
        document.body.style.overflow = 'hidden';
      };

      const closeDialog = () => {
        if (overlay) overlay.hidden = true;
        if (content) content.hidden = true;
        document.body.style.overflow = '';
        
        // Clear input and reset filter
        const input = content?.querySelector('[data-command-input]') as HTMLInputElement;
        if (input) {
          input.value = '';
          input.dispatchEvent(new Event('input'));
        }
      };

      // Trigger click
      trigger?.addEventListener('click', openDialog);

      // Close on overlay click
      overlay?.addEventListener('click', (e) => {
        if (e.target === overlay) closeDialog();
      });

      // Keyboard shortcut (Cmd/Ctrl + K)
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          if (overlay?.hidden) {
            openDialog();
          } else {
            closeDialog();
          }
        }
        
        // Close on Escape
        if (e.key === 'Escape' && overlay && !overlay.hidden) {
          closeDialog();
        }
      });
    });
  }

  initCommandDialogs();
  document.addEventListener('astro:page-load', initCommandDialogs);
</script>
