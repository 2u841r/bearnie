---
import { cn } from '@/utils/cn';
import type { HTMLAttributes } from 'astro/types';

export interface Props extends HTMLAttributes<'div'> {}

const { class: className, ...props } = Astro.props;
---

<div class={cn('relative inline-block', className)} data-popover {...props}>
  <slot />
</div>

<script>
  import { generateId } from '@/utils/focus-trap';

  function initPopovers() {
    document.querySelectorAll('[data-popover]').forEach((popover) => {
      if (popover.hasAttribute('data-initialized')) return;
      popover.setAttribute('data-initialized', 'true');

      const trigger = popover.querySelector('[data-popover-trigger]') as HTMLElement;
      const content = popover.querySelector('[data-popover-content]') as HTMLElement;

      if (!trigger || !content) return;

      // Generate ID for content if not present
      if (!content.id) {
        content.id = generateId('popover');
      }

      // Set ARIA attributes on trigger
      trigger.setAttribute('aria-haspopup', 'dialog');
      trigger.setAttribute('aria-controls', content.id);
      trigger.setAttribute('aria-expanded', 'false');

      const openPopover = () => {
        content.hidden = false;
        trigger.setAttribute('aria-expanded', 'true');
        // Focus first focusable element in popover
        const firstFocusable = content.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])') as HTMLElement;
        firstFocusable?.focus();
      };

      const closePopover = () => {
        content.hidden = true;
        trigger.setAttribute('aria-expanded', 'false');
        trigger.focus();
      };

      const togglePopover = () => {
        if (content.hidden) {
          openPopover();
        } else {
          closePopover();
        }
      };

      trigger.addEventListener('click', togglePopover);

      // Close on click outside
      document.addEventListener('click', (e) => {
        if (!popover.contains(e.target as Node) && !content.hidden) {
          closePopover();
        }
      });

      // Close on Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !content.hidden) {
          closePopover();
        }
      });
    });
  }

  initPopovers();
  document.addEventListener('astro:page-load', initPopovers);
</script>
